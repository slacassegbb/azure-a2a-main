services:
  # ============================================================================
  # Core Services - A2A Multi-Agent Platform
  # ============================================================================
  
  backend:
    platform: linux/amd64
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: a2a-backend
    ports:
      - "12000:12000"
      - "8080:8080"
    environment:
      - A2A_UI_HOST=0.0.0.0
      - A2A_UI_PORT=12000
      - WEBSOCKET_SERVER_URL=http://localhost:8080
      - AZURE_CONFIG_DIR=/root/.azure
      - HOME=/root
    env_file:
      - .env
    volumes:
      # Persist data directories
      - ./backend/data:/app/data
      - ./backend/uploads:/app/uploads
      - ./backend/voice_recordings:/app/voice_recordings
      # Mount Azure credentials for DefaultAzureCredential
      - ~/.azure:/root/.azure:ro
    networks:
      a2a-network:
        aliases:
          - localhost
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:12000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  frontend:
    platform: linux/amd64
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: a2a-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_A2A_API_URL=http://localhost:12000
      - NEXT_PUBLIC_WEBSOCKET_URL=ws://localhost:8080/events
      - NEXT_PUBLIC_DEV_MODE=false
      - NEXT_PUBLIC_DEBUG_LOGS=false
    env_file:
      - .env
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - a2a-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 100s

  # ============================================================================
  # Remote Agents - Uncomment and configure as needed
  # Each agent needs its own .env file with Azure credentials
  # ============================================================================
  
  # Example: Fraud Detection Agent
  # fraud-agent:
  #   platform: linux/amd64
  #   build:
  #     context: ./remote_agents/azurefoundry_fraud
  #     dockerfile: Dockerfile
  #   container_name: a2a-fraud-agent
  #   ports:
  #     - "9004:9004"
  #   environment:
  #     - A2A_PORT=9004
  #     - A2A_HOST=0.0.0.0
  #   env_file:
  #     - ./remote_agents/azurefoundry_fraud/.env
  #   volumes:
  #     - ~/.azure:/root/.azure:ro
  #   networks:
  #     - a2a-network
  #   depends_on:
  #     backend:
  #       condition: service_healthy
  #   restart: unless-stopped

  # Example: Classification Agent
  # classification-agent:
  #   platform: linux/amd64
  #   build:
  #     context: ./remote_agents/azurefoundry_classification
  #     dockerfile: Dockerfile
  #   container_name: a2a-classification-agent
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     - A2A_PORT=8001
  #     - A2A_HOST=0.0.0.0
  #   env_file:
  #     - ./remote_agents/azurefoundry_classification/.env
  #   volumes:
  #     - ~/.azure:/root/.azure:ro
  #   networks:
  #     - a2a-network
  #   depends_on:
  #     backend:
  #       condition: service_healthy
  #   restart: unless-stopped

networks:
  a2a-network:
    driver: bridge

volumes:
  backend-data:
  backend-uploads:
  backend-voice:
