# Image Generator Deployment Fix

## Issue Summary
Images generated by the Azure AI Foundry Image Generator agent were not displaying in the UI because the agent was saving images to local storage (`sandbox:/app/static/outputs/...`) instead of uploading them to Azure Blob Storage.

## Root Cause
The Image Generator container was missing three critical environment variables:
- `FORCE_AZURE_BLOB=true` - Enables blob storage upload
- `AZURE_STORAGE_CONNECTION_STRING` - Connection string for Azure Storage account
- `AZURE_BLOB_CONTAINER=a2a-files` - Target container name

## Fixes Applied

### 1. Manual Container Fix (Immediate)
Updated the existing `azurefoundry-image-generator` container with the required environment variables:

```bash
az containerapp update --name azurefoundry-image-generator --resource-group rg-a2a-prod \
  --set-env-vars \
    "FORCE_AZURE_BLOB=true" \
    "AZURE_STORAGE_CONNECTION_STRING=<connection_string>" \
    "AZURE_BLOB_CONTAINER=a2a-files"
```

**Status**: ✅ Complete - Container now uploads images to blob storage

### 2. Deployment Script Updates (Future Deployments)

#### `deploy-remote-agent.sh` Changes:
1. **Read blob storage config from .env files** (Lines ~110-118):
   - Added reading of `AZURE_STORAGE_CONNECTION_STRING` from agent or root `.env` file
   - Automatically loads connection string when available

2. **Add blob storage env vars on update** (Lines ~235-241):
   - Detects if agent name contains "image_generator"
   - Automatically adds blob storage environment variables
   - Shows confirmation message

3. **Add blob storage env vars on create** (Lines ~254-260):
   - Same detection and configuration for new deployments
   - Ensures consistent setup

#### `deploy-remote-agent.ps1` Changes:
1. **Enhanced .env file reading** (Lines ~53-88):
   - Added automatic reading of `AZURE_STORAGE_CONNECTION_STRING`
   - Also reads `OPENAI_API_KEY` for image generator
   - Provides better feedback on loaded configuration

2. **Add blob storage env vars on update** (Lines ~173-203):
   - PowerShell array-based env var management
   - Conditional blob storage configuration for image generator
   - Shows confirmation message

3. **Add blob storage env vars on create** (Lines ~206-243):
   - Same detection logic for new deployments
   - Consistent configuration across create and update

## How It Works

### Agent Detection
Both scripts detect the Image Generator by checking if the agent name contains `"image_generator"`:
- Bash: `[[ "$AGENT_NAME" == *"image_generator"* ]]`
- PowerShell: `$AgentName -like "*image_generator*"`

### Environment Variable Source
The scripts read from `.env` files in this order:
1. Agent-specific `.env` file: `remote_agents/azurefoundry_image_generator/.env`
2. Root `.env` file: `.env`

### Auto-Configuration
When deploying the Image Generator agent:
1. Script detects it's an image generator
2. Reads `AZURE_STORAGE_CONNECTION_STRING` from `.env`
3. Automatically adds three environment variables:
   - `FORCE_AZURE_BLOB=true`
   - `AZURE_STORAGE_CONNECTION_STRING=<from .env>`
   - `AZURE_BLOB_CONTAINER=a2a-files`
4. Shows confirmation: "✅ Blob storage configuration added for Image Generator"

## Testing

### To test the fix:
1. Generate an image: "Generate a realistic image of a cat"
2. Verify the image displays in:
   - ✅ Chat UI (main message area)
   - ✅ Agent Workflow sidebar
   - ✅ File History panel

### To test deployment scripts:
```bash
# Bash
./deploy-remote-agent.sh -a azurefoundry_image_generator -p 9010

# PowerShell
./deploy-remote-agent.ps1 -AgentName azurefoundry_image_generator -Port 9010
```

Both should show: "✅ Blob storage configuration added for Image Generator"

## Required .env Configuration

Ensure your `.env` file contains:
```env
AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=a2astoragefilesa2a;AccountKey=<key>;EndpointSuffix=core.windows.net
AZURE_BLOB_CONTAINER=a2a-files
OPENAI_API_KEY=<your-openai-key>
```

## Impact
- **Existing deployments**: Already fixed with manual update
- **Future deployments**: Automatically configured by updated scripts
- **Other agents**: No impact - blob storage config only applies to image_generator

## Files Modified
1. `/deploy-remote-agent.sh` - Bash deployment script
2. `/deploy-remote-agent.ps1` - PowerShell deployment script

## Commit Message Suggestion
```
fix: Add blob storage configuration for Image Generator deployments

- Auto-detect image generator agent in deployment scripts
- Read AZURE_STORAGE_CONNECTION_STRING from .env files
- Add FORCE_AZURE_BLOB, connection string, and container name
- Support both create and update operations
- Works in both Bash and PowerShell scripts

Fixes image display in chat UI, workflow sidebar, and file history
```
