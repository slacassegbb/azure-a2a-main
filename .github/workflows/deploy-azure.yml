name: Deploy to Azure Container Apps

# Required GitHub Secrets:
# - AZURE_CREDENTIALS: Azure Service Principal credentials for authentication
# - AZURE_AI_FOUNDRY_PROJECT_ENDPOINT: Azure AI Foundry project endpoint
# - AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME: Model deployment name (e.g., gpt-4o)
# - AZURE_OPENAI_GPT_API_BASE: Azure OpenAI API base URL
# - AZURE_OPENAI_GPT_API_KEY: Azure OpenAI API key
# - AZURE_OPENAI_GPT_DEPLOYMENT: OpenAI deployment name
# - AZURE_OPENAI_EMBEDDINGS_ENDPOINT: Embeddings endpoint URL
# - AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT: Embeddings deployment name
# - AZURE_OPENAI_EMBEDDINGS_KEY: Embeddings API key
# - AZURE_SEARCH_SERVICE_ENDPOINT: Azure Search service endpoint (for memory service)
# - AZURE_SEARCH_ADMIN_KEY: Azure Search admin key
# - AZURE_SEARCH_INDEX_NAME: Azure Search index name (e.g., microsoft-results)
# - BING_CONNECTION_ID: (Optional) Bing Grounding connection ID for web search

on:
  push:
    branches: [ main, feature/multi-tenancy, benjamin-highschool ]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: a2awestuslab.azurecr.io
  RESOURCE_GROUP: rg-a2a-prod
  LOCATION: westus2

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      websocket: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        run: |
          az acr login --name a2awestuslab
      
      - name: Build and Push Frontend
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_A2A_API_URL="https://backend-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io" \
            --build-arg NEXT_PUBLIC_WEBSOCKET_URL="wss://websocket-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io/events" \
            --build-arg NEXT_PUBLIC_DEV_MODE="false" \
            -t ${{ env.REGISTRY }}/frontend:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/frontend:latest \
            ./frontend
          docker push ${{ env.REGISTRY }}/frontend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/frontend:latest
      
      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name frontend-uami \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/frontend:${{ github.sha }}
      
      - name: Verify Deployment
        run: |
          echo "âœ… Frontend deployed successfully!"
          echo "ğŸŒ URL: https://frontend-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        run: |
          az acr login --name a2awestuslab
      
      - name: Build and Push Backend
        run: |
          docker build -t ${{ env.REGISTRY }}/backend:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/backend:latest \
                       -f backend/Dockerfile \
                       .
          docker push ${{ env.REGISTRY }}/backend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/backend:latest
      
      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name backend-uami \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/backend:${{ github.sha }} \
            --set-env-vars \
              "SECRET_KEY=${{ secrets.SECRET_KEY }}" \
              "USE_PROD_REGISTRY=true" \
              "AZURE_AI_FOUNDRY_PROJECT_ENDPOINT=${{ secrets.AZURE_AI_FOUNDRY_PROJECT_ENDPOINT }}" \
              "AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME=${{ secrets.AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME }}" \
              "AZURE_OPENAI_GPT_API_BASE=${{ secrets.AZURE_OPENAI_GPT_API_BASE }}" \
              "AZURE_OPENAI_GPT_API_KEY=${{ secrets.AZURE_OPENAI_GPT_API_KEY }}" \
              "AZURE_OPENAI_GPT_DEPLOYMENT=${{ secrets.AZURE_OPENAI_GPT_DEPLOYMENT }}" \
              "AZURE_OPENAI_EMBEDDINGS_ENDPOINT=${{ secrets.AZURE_OPENAI_EMBEDDINGS_ENDPOINT }}" \
              "AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT=${{ secrets.AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT }}" \
              "AZURE_OPENAI_EMBEDDINGS_KEY=${{ secrets.AZURE_OPENAI_EMBEDDINGS_KEY }}" \
              "AZURE_SEARCH_SERVICE_ENDPOINT=${{ secrets.AZURE_SEARCH_SERVICE_ENDPOINT }}" \
              "AZURE_SEARCH_ADMIN_KEY=${{ secrets.AZURE_SEARCH_ADMIN_KEY }}" \
              "AZURE_SEARCH_INDEX_NAME=${{ secrets.AZURE_SEARCH_INDEX_NAME }}" \
              "BING_CONNECTION_ID=${{ secrets.BING_CONNECTION_ID }}" \
              "WEBSOCKET_SERVER_URL=https://websocket-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io" \
              "A2A_HOST=FOUNDRY" \
              "VERBOSE_LOGGING=true"
      
      - name: Verify Deployment
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "ğŸŒ URL: https://backend-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"

  deploy-websocket:
    needs: detect-changes
    if: needs.detect-changes.outputs.websocket == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        run: |
          az acr login --name a2awestuslab
      
      - name: Build and Push WebSocket
        run: |
          docker build -f backend/Dockerfile.websocket \
                       -t ${{ env.REGISTRY }}/websocket:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/websocket:latest \
                       backend
          docker push ${{ env.REGISTRY }}/websocket:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/websocket:latest
      
      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name websocket-uami \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/websocket:${{ github.sha }} \
            --set-env-vars \
              "SECRET_KEY=${{ secrets.SECRET_KEY }}"
      
      - name: Verify Deployment
        run: |
          echo "âœ… WebSocket deployed successfully!"
          echo "ğŸŒ URL: https://websocket-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"

  notify-complete:
    needs: [deploy-frontend, deploy-backend, deploy-websocket]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Production URLs:"
          echo "  Frontend:  https://frontend-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"
          echo "  Backend:   https://backend-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"
          echo "  WebSocket: https://websocket-uami.ambitioussky-6c709152.westus2.azurecontainerapps.io"
          echo ""
          echo "ğŸ¯ Test your changes now!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
